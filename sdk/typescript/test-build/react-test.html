<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamASR React Hook Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .transcript {
            background: white;
            padding: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>StreamASR React Hook Test</h1>
    <div id="root"></div>

    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 构建后的React hooks -->
    <script src="../dist/react.js"></script>
    <!-- 构建后的主SDK -->
    <script src="../dist/index.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // 模拟React Hook的组件
        function StreamASRTest() {
            const [client, setClient] = useState(null);
            const [isConnected, setIsConnected] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [transcript, setTranscript] = useState('');
            const [error, setError] = useState('');
            const [status, setStatus] = useState('Initializing...');

            useEffect(() => {
                // 测试SDK加载
                if (typeof StreamASR !== 'undefined') {
                    setStatus('SDK loaded successfully');

                    try {
                        const newClient = new StreamASR.StreamASRClient({
                            url: 'ws://localhost:8080/v1/realtime',
                            apiKey: 'test-key',
                            enableLogging: true
                        });

                        setClient(newClient);
                        setupEventListeners(newClient);
                        setStatus('Client created successfully');
                    } catch (err) {
                        setError(err.message);
                        setStatus('Failed to create client');
                    }
                } else {
                    setStatus('SDK not loaded');
                }
            }, []);

            const setupEventListeners = (clientInstance) => {
                clientInstance.on('connectionStateChanged', (state) => {
                    setIsConnected(state.connected);
                    setStatus(state.connected ? 'Connected' : 'Disconnected');
                });

                clientInstance.on('recordingStateChanged', (state) => {
                    setIsRecording(state.isRecording);
                });

                clientInstance.on('transcription', (data) => {
                    setTranscript(prev => data.text + '\n' + prev);
                });

                clientInstance.on('error', (errorData) => {
                    setError(errorData.message);
                });
            };

            const handleConnect = async () => {
                if (client) {
                    try {
                        await client.connect();
                    } catch (err) {
                        setError(err.message);
                    }
                }
            };

            const handleDisconnect = () => {
                if (client) {
                    client.disconnect();
                }
            };

            const handleToggleRecording = async () => {
                if (client) {
                    try {
                        if (isRecording) {
                            client.stopRecording();
                        } else {
                            await client.startRecording();
                        }
                    } catch (err) {
                        setError(err.message);
                    }
                }
            };

            return (
                <div>
                    <div className="container">
                        <h3>Status</h3>
                        <div className={`status ${error ? 'error' : 'info'}`}>
                            {error || status}
                        </div>

                        <div>
                            <strong>Connection:</strong> {isConnected ? 'Connected' : 'Disconnected'} |
                            <strong>Recording:</strong> {isRecording ? 'Recording' : 'Not Recording'}
                        </div>
                    </div>

                    <div className="container">
                        <h3>Controls</h3>
                        <button
                            className="btn-primary"
                            onClick={handleConnect}
                            disabled={isConnected}
                        >
                            Connect
                        </button>
                        <button
                            className="btn-danger"
                            onClick={handleDisconnect}
                            disabled={!isConnected}
                        >
                            Disconnect
                        </button>
                        <button
                            className={isRecording ? "btn-danger" : "btn-primary"}
                            onClick={handleToggleRecording}
                            disabled={!isConnected}
                        >
                            {isRecording ? 'Stop Recording' : 'Start Recording'}
                        </button>
                    </div>

                    <div className="container">
                        <h3>Transcript</h3>
                        <div className="transcript">
                            {transcript || 'No transcript yet...'}
                        </div>
                    </div>
                </div>
            );
        }

        // 渲染组件
        ReactDOM.render(<StreamASRTest />, document.getElementById('root'));
    </script>
</body>
</html>